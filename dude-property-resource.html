<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../dude-hierarchy/dude-hierarchy.html">
<link rel="import" href="../dude-popup/dude-popup.html">
<dom-module id="dude-property-resource">
    <style>
        #openButton {
            background: #444444;
            width: 100%;
            font-family: var(--dude-primary-text-font);
            color: var(--dude-content-text-color);
            border: none;
            padding: 8px;
            margin: 0;
        }

        #popup dude-hierarchy {
            width: 300px;
            max-width: 100%;
            background: var(--dude-secondary-background-color);
            box-shadow: 0 3px 10px var(--dude-primary-background-color);
            padding: 5px;
        }
    </style>
    <template>
        <paper-button id="openButton" class="layout horizontal" on-click="_openResources">
            <i class$="[[ resource.icon ]]"></i>
            <span hidden$="[[ resource ]]" class="flex">(None)</span>
            <span hidden$="[[ !resource ]]" class="flex">[[ resource.name ]]</span>
        </paper-button>
        <dude-popup id="popup">
            <dude-hierarchy id="hierarchy"
                            items="{{ resources }}"
                            placeholder="Search resources..."
                            editable
                            on-dude-hierarchy-item-submit="_selectResource"
                            on-dude-hierarchy-add-item="_addResource">
            </dude-hierarchy>
        </dude-popup>
    </template>
    <script>
        Polymer({
            is: "dude-property-resource",

            behaviors: [Polymer.IronA11yKeysBehavior],

            properties: {
                /**
                 * The current selected resource
                 */
                "resource": {
                    "type": Object,
                    "value": null,
                    "notify": true
                },

                /**
                 * The list of resources
                 */
                "resources": {
                    "type": Array,
                    "value": []
                }
            },

            /**
             * Called when the dude property resource is ready
             * @delegate
             */
            ready: function () {
                this.keyEventTarget = document.body;
                this.addOwnKeyBinding("up", "_up");
                this.addOwnKeyBinding("down", "_down");
                this.addOwnKeyBinding("right", "_right");
                this.addOwnKeyBinding("left", "_left");
                this.addOwnKeyBinding("enter", "_submit");
                this.addOwnKeyBinding("esc", "_closeResources");
            },

            /**
             * Called when clicking on the resource button
             * Open the resources dialog.
             * @param {CustomEvent} e
             * @param {Number} e.x
             * @param {Number} e.y
             * @delegate
             * @private
             */
            _openResources: function (e) {
                this.$.popup.open(e.x, e.y);
                this.$.hierarchy.focus();
            },

            /**
             * Called when pressing escape
             * Closes the resource popup
             * @delegate
             * @private
             */
            _closeResources: function () {
                this.$.popup.close();
            },

            _up: function () {
                this.$.hierarchy.moveUp();
            },

            _down: function () {
                this.$.hierarchy.moveDown();
            },

            _right: function () {
                this.$.hierarchy.moveRight();
            },

            _left: function () {
                this.$.hierarchy.moveLeft();
            },

            _submit: function () {
                this.$.hierarchy.submit();
                this.$.popup.close();
            },

            /**
             * Called when a resource is selected
             * @param {CustomEvent} e
             * @delegate
             * @private
             */
            _selectResource: function (e) {
                this.resource = e.detail.item;
                this.$.popup.close();
            },

            /**
             * Called when clicking on add resource
             * @delegate
             * @private
             */
            _addResource: function () {
                this.fire("dude-property-add-resource");
            }
        });
    </script>
</dom-module>