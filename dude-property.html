<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-input/iron-input.html">
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../dude-popup/dude-popup.html">
<link rel="import" href="dude-property-resource.html">
<!--
`dude-property` A generic picker which adapts automatically according to the type of the given value.

@group dude Elements
@element dude-property
@demo demo/index.html
-->
<dom-module id="dude-property">
    <style>
        :host {
            display: block;
            padding: 10px 0;
            --dude-property-label-color: var(--dude-secondary-text-color);
        }

        label {
            display: block;
            padding-bottom: 5px;
            font-family: var(--dude-primary-text-font);
            color: var(--dude-property-label-color);
            font-size: .8em;
        }

        input[type="text"], input[type="number"] {
            color: var(--dude-content-text-color);
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--dude-property-label-color);
            outline: none;
            font-size: 1em;
            font-family: var(--dude-content-text-font);
        }

        input[type="text"]:not(:first-child), input[type="number"]:not(:first-child) {
            margin-left: 10px;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            border-bottom: 2px solid var(--dude-primary-color);
        }
        input::-webkit-input-placeholder {
            color: var(--dude-secondary-text-color);
        }
        input:-moz-placeholder {
            /* FF 4-18 */
            color: var(--dude-secondary-text-color);
        }
        input::-moz-placeholder {
            /* FF 19+ */
            color: var(--dude-secondary-text-color);
        }
        input:-ms-input-placeholder {
            /* IE 10+ */
            color: var(--dude-secondary-text-color);
        }
        #unknown {
            font-family: var(--dude-content-text-font);
            color: var(--dude-content-text-color);
            padding-top: 8px;
        }
        #picker {
            height: 32px;
        }
        a > i {
            padding: 8px;
            color: var(--dude-secondary-text-color);
            cursor: pointer;
        }
        #tag {
            padding-left: 10px;
            background: var(--dude-primary-color);
            font-family: var(--dude-content-text-font);
        }
        #tag span {
            padding-top: 8px;
        }
        #menu paper-menu {
            background: var(--dude-secondary-background-color);
            box-shadow: 0 3px 10px var(--dude-primary-background-color);
        }
    </style>
    <template>
        <label>[[ propertyName ]]</label>
        <div hidden$="[[ propertyReference ]]" id="picker" class="layout horizontal">
            <template is="dom-if" if="{{ !propertyReference }}" restamp>
                <template is="dom-if" if="{{ _isType(propertyType, 'unknown') }}" restamp>
                    <div id="unknown" class="layout horizontal flex">(None)</div>
                </template>
                <template is="dom-if" if="{{ _isType(propertyType, 'choice') }}" restamp>
                    <div data-type="choice" class="layout horizontal flex">
                        <paper-dropdown-menu label="(None)" no-label-float class="flex">
                            <paper-menu class="dropdown-content" attr-for-selected="name" selected="{{ propertyValue }}">
                                <template is="dom-repeat" items="[[ propertyChoice ]]">
                                    <paper-item name="[[ item ]]">[[ item ]]</paper-item>
                                </template>
                            </paper-menu>
                        </paper-dropdown-menu>
                    </div>
                </template>
                <template is="dom-if" if="{{ _isType(propertyType, 'vec4') }}" restamp>
                    <div class="layout horizontal flex">
                        <input is="input" value="{{ propertyValue.x::input }}" bind-value="{{ propertyValue.x }}" placeholder="x" class="flex" type="number">
                        <input is="input" value="{{ propertyValue.y::input }}" bind-value="{{ propertyValue.y }}" placeholder="y" class="flex" type="number">
                        <input is="input" value="{{ propertyValue.z::input }}" bind-value="{{ propertyValue.z }}" placeholder="z" class="flex" type="number">
                        <input is="input" value="{{ propertyValue.w::input }}" bind-value="{{ propertyValue.w }}" placeholder="w" class="flex" type="number">
                    </div>
                </template>
                <template is="dom-if" if="{{ _isType(propertyType, 'vec3') }}" restamp>
                    <div class="layout horizontal flex">
                        <input is="input" value="{{ propertyValue.x::input }}" bind-value="{{ propertyValue.x }}" placeholder="x" class="flex" type="number">
                        <input is="input" value="{{ propertyValue.y::input }}" bind-value="{{ propertyValue.y }}" placeholder="y" class="flex" type="number">
                        <input is="input" value="{{ propertyValue.z::input }}" bind-value="{{ propertyValue.z }}" placeholder="z" class="flex" type="number">
                    </div>
                </template>
                <template is="dom-if" if="{{ _isType(propertyType, 'vec2') }}" restamp>
                    <div class="layout horizontal flex">
                        <input is="input" value="{{ propertyValue.x::input }}" bind-value="{{ propertyValue.x }}" placeholder="x" class="flex" type="number">
                        <input is="input" value="{{ propertyValue.y::input }}" bind-value="{{ propertyValue.y }}" placeholder="y" class="flex" type="number">
                    </div>
                </template>
                <template is="dom-if" if="{{ _isType(propertyType, 'number') }}" restamp>
                    <div class="layout horizontal flex">
                        <input is="input" value="{{ propertyValue::input }}" bind-value="{{ propertyValue }}" class="flex" type="number" placeholder="(None)">
                    </div>
                </template>
                <template is="dom-if" if="{{ _isType(propertyType, 'string') }}" restamp>
                    <div class="layout horizontal flex">
                        <input is="input" value="{{ propertyValue::input }}" bind-value="{{ propertyValue }}" class="flex" type="text" placeholder="(None)">
                    </div>
                </template>
                <template is="dom-if" if="{{ _isType(propertyType, 'resource') }}" restamp>
                    <div class="layout horizontal flex">
                        <dude-property-resource
                                class="flex"
                                resource="{{ propertyValue }}"
                                resources="{{ propertyResources }}">
                        </dude-property-resource>
                    </div>
                </template>
                <template is="dom-if" if="{{ _isType(propertyType, 'range') }}" restamp>
                    <div class="layout horizontal flex">
                        <paper-slider value="{{ propertyValue }}" class="flex"
                            min="{{ propertyRange.min }}"
                            max="{{ propertyRange.max }}"
                            step="{{ propertyRange.step }}" pin>
                        </paper-slider>
                    </div>
                </template>
                <template is="dom-if" if="{{ _isType(propertyType, 'boolean') }}" restamp>
                    <div class="layout horizontal flex" style="padding-top: 5px; padding-left: 10px">
                        <paper-toggle-button id="booleanPicker" on-change="_updateBoolean"></paper-toggle-button>
                    </div>
                </template>
            </template>
            <template is="dom-if" if="[[ !propertyReference ]]">
                <a hidden$="[[ noMenu ]]" on-click="_openMenu"><i class="fa fa-dot-circle-o"></i></a>
            </template>
        </div>
        <div hidden$="[[ !propertyReference ]]" id="tag" class="layout horizontal">
            <span class="flex">[[ propertyReference.name ]]</span>
            <a on-click="_removeReference"><i class="fa fa-times-circle"></i></a>
        </div>
        <dude-popup id="menu">
            <paper-menu class="dropdown-content" attr-for-selected="name" selected="{{ menuItem }}">
                <paper-item name="clear">Clear</paper-item>
            </paper-menu>
        </dude-popup>
    </template>
    <script>
        Polymer({

            is: "dude-property",

            behaviors: [Polymer.IronA11yKeysBehavior],

            properties: {

                /**
                 * Disable reference for this property.
                 */
                "noMenu": {
                    "type": "boolean",
                    "value": false
                },

                /**
                 * Represents the name of this property. It will also be used to display the property label.
                 */
                "propertyName": {
                    "type": String
                },

                /**
                 * Represents the type of this property. It will be used to switch to the appropriate picker.
                 */
                "propertyType": {
                    "type": String
                },

                /**
                 * Stores the current value of the property. It will be updated by the picker, but also the other
                 * way around. This value can be null, when there is a reference for example.
                 */
                "propertyValue": {
                    "type": Object,
                    "notify": true,
                    "observer": "_propertyValueChanged"
                },

                /**
                 * By default this value is not, otherwise it represents a reference on a variable instead of a direct
                 * value.
                 */
                "propertyReference": {
                    "type": Object,
                    "value": null
                },

                /**
                 * This is only used by properties of type "choice". It references all the possible choices.
                 */
                "propertyChoice": {
                    "type": Array,
                    "value": []
                },

                /**
                 * This is only used by properties of type "resource". It references all the possible resources.
                 */
                "propertyResources": {
                    "type": Array,
                    "value": []
                },

                /**
                 * This is only used by properties of type "range". It configures the slider by given the `min`, `max`
                 * and `step` values.
                 */
                "propertyRange": {
                    "type": Object,
                    "value": {min: 1, max: 10, step: 1}
                },

                "menuItem": {
                    "type": String,
                    "value": null,
                    "observer": "_menuItemChanged"
                }
            },

            /**
             * Called when the element is attached to the dom. Checks if there is some property-value related updates
             * to do during initialization.
             */
            attached: function () {
                this.keyEventTarget = document.body;
                this.addOwnKeyBinding("esc", "_closeMenu");
                this._propertyValueChanged();
            },

            /**
             * Checks whether the given typeName is the same as the property type.
             * @param {String} propertyType
             * @param {String} typeName
             * @returns {Boolean}
             * @private
             */
            _isType: function (propertyType, typeName) {
                if (propertyType === null && typeName === "unknown") {
                    return true;
                }
                return propertyType == typeName;
            },

            /**
             * Opens a menu to perform actions on the property.
             * @param {Object} e Contains event information
             */
            _openMenu: function (e) {
                this.$.menu.open(e.x, e.y);
            },

            /**
             * Closes the menu.
             */
            _closeMenu: function () {
                this.$.menu.close();
            },

            /**
             * Called when the menu item changes.
             */
            _menuItemChanged: function () {
                if (this.menuItem !== null) {
                    if (this.menuItem === "clear") {
                        this.propertyValue = null;
                    } else if (this.menuItem === "addReference") {
                        console.log("Add reference...");
                    }
                    this.menuItem = null;
                    this._closeMenu();
                }
            },

            /**
             * Called when adding a dude property reference
             * @delegate
             * @private
             */
            _addReference: function () {
                this.fire("dude-property-add-reference");
                this.set("propertyReference", {
                    "name": "my_reference"
                });
            },

            /**
             * Called when the dude property reference is removed
             * @delegate
             * @private
             */
            _removeReference: function () {
                this.fire("dude-property-remove-reference", {
                    reference: this.propertyReference
                });
                this.set("propertyReference", null);
            },

            /**
             * Called when the property value changes. It will be used to handle some exceptions depending on the
             * type of property to update (for example, when bindings doesn't work).
             * @private
             */
            _propertyValueChanged: function () {
                if (this.get("propertyType") === "boolean") {
                    var booleanPicker = this.querySelector("#booleanPicker");
                    if (booleanPicker !== null) {
                        if (this.get("propertyValue")) {
                            booleanPicker.setAttribute("checked", "");
                        } else {
                            booleanPicker.removeAttribute("checked");
                        }
                    }
                }
            },

            /**
             * This updates boolean values by watching paper-toggle-button's "on-change" event.
             * @private
             */
            _updateBoolean: function () {
                this.set("propertyValue", !this.get("propertyValue"));
            }
        });
    </script>
</dom-module>
