<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../dude-style/dude-style.html">
<link rel="import" href="dude-property-text.html">
<link rel="import" href="dude-property-color.html">
<link rel="import" href="dude-property-string.html">
<link rel="import" href="dude-property-boolean.html">
<link rel="import" href="dude-property-resource.html">
<!--
`dude-property` A generic picker which adapts automatically according to the type of the given value.

@group dude Elements
@element dude-property
@demo demo/index.html
-->
<dom-module id="dude-property">
    <style include="iron-flex"></style>
    <style>
        .parent {
            @apply(--layout-horizontal);
            @apply(--layout-flex);
        }

        .property {
            @apply(--layout-flex);
            @apply(--layout-self-start);
        }

        .clear {
            @apply(--layout-self-center);
        }

        .property-label {
            color: var(--dude-content-text-color);
        }
    </style>
    <template>
        <div id="container" hidden$="[[ !_propertyManaged ]]">
            <div class="parent">
                <div id="property" class="property">
                    <label class="property-label">[[ propertyName ]]</label>
                </div>
                <div class="clear">
                    <button on-click="clear">Clear</button>
                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: "dude-property",
            properties: {
                /**
                 * The managed property types
                 */
                "propertyElementTypes": {
                    "type": Object,
                    "value": {
                        "Text": "dude-property-text",
                        "Color": "dude-property-color",
                        "String": "dude-property-string",
                        "Number": "dude-property-string",
                        "Boolean": "dude-property-boolean",
                        "Resource": "dude-property-resource"
                    }
                },

                /**
                 * Property type
                 */
                "propertyType": {
                    "type": String,
                    "readonly": true,
                    "observer": "_propertyTypeChanged"
                },

                /**
                 * Property name
                 */
                "propertyName": {
                    "type": String,
                    "readonly": true
                },

                /**
                 * Property data
                 */
                "propertyData": {
                    "type": Object,
                    "readonly": true
                },

                /**
                 * Property value
                 */
                "propertyValue": {
                    "type": Object,
                    "notify": true,
                    "observer": "_propertyValueChanged"
                }
            },
            listeners: {
                "dude-property-ready": "_propertyElementReady",
                "dude-property-value-change": "_propertyElementValueChanged"
            },

            /**
             * The property element
             * @type {HTMLElement}
             * @private
             */
            _propertyElement: null,

            /**
             * Whether the property element is ready
             * @type {Boolean}
             * @private
             */
            _propertyElementIsReady: false,

            /**
             * Whether the property type is managed
             * @type {Boolean}
             * @private
             */
            _propertyManaged: false,

            /**
             * Registers the given propertyType with the given propertyElementName
             * @param {String} propertyType
             * @param {String} propertyElementName
             */
            registerPropertyElement: function (propertyType, propertyElementName) {
                var propertyElement = this.get("propertyElementTypes")[propertyType];
                if (typeof propertyElement === "undefined") {
                    console.warn("`" + propertyType + "` already managed");
                    return;
                }
                this.get("propertyElementTypes")[propertyType] = propertyElementName;
            },

            /**
             * Clears the property by setting it to nul
             */
            clear: function () {
                this.set("propertyValue", null);
            },

            /**
             * Creates the property element for the given propertyType
             * @param {String} propertyType
             * @private
             */
            _createPropertyElement(propertyType) {
                var propertyElement = this.get("propertyElementTypes")[propertyType];
                if (typeof propertyElement === "undefined") {
                    this.set("_propertyManaged", false);
                    console.warn("`" + propertyType + "` not managed");
                    return;
                }
                this.set("_propertyManaged", true);
                this._propertyElement = document.createElement(propertyElement);
                this.$.property.appendChild(this._propertyElement);
            },

            /**
             * Called when the property type changed
             * Will create the appropriate property element
             * @private
             */
            _propertyTypeChanged: function (propertyType) {
                if (this._propertyElement !== null && this._propertyElement.get("propertyType") !== propertyType) {
                    this.$.property.removeChild(this._propertyElement);
                    this._propertyElement = null;
                    this.set("_propertyElementIsReady", false);
                }
                if (this._propertyElement === null) {
                    this._createPropertyElement(propertyType);
                }
            },

            /**
             * Called when the propertyValue changed
             * Notifies the custom element that the property value changed
             * @private
             */
            _propertyValueChanged: function (propertyValue) {
                if (this.get("_propertyElementIsReady")) {
                    if (this._propertyElement.get("propertyValue") !== propertyValue) {
                        this._propertyElement.setPropertyValue(this.get("propertyValue"));
                    }
                }
            },

            /**
             * Called when the property element is ready
             * @private
             */
            _propertyElementReady: function () {
                this.set("_propertyElementIsReady", true);
                this._propertyElement.set("propertyType", this.get("propertyType"));
                this._propertyElement.set("propertyName", this.get("propertyName"));
                this._propertyElement.set("propertyData", this.get("propertyData"));
                this._propertyElement.setPropertyValue(this.get("propertyValue"));
            },

            /**
             * Called when the property element value is updated
             * @private
             */
            _propertyElementValueChanged: function () {
                if (this.get("_propertyElementIsReady")) {
                    this.set("propertyValue", this._propertyElement.get("propertyValue"));
                }
            }
        });
    </script>
</dom-module>